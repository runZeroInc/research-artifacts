#!/bin/zsh
#
# cve-rejected-audit.sh
#
#   Analyze rejected and disputed CVE records for hints on what's up there.
#
# Usage
#   ./cve-rejected-audit.sh --repo /path/to/cvelistV5 [options]
#
# Options
#   --repo PATH
#       Path to a local cvelistV5 git clone of http://github.com/cveproject/cvelistV5/
#   --year YYYY
#       CVE label year to analyze (default: 2025)
#   --force
#       Overwrite existing cveaudit-*.txt files
#   --help, -h
#       This help text

# Source: https://github.com/runzeroInc/research-artifacts/
# See also: https://www.runzero.com/blog/all-american-cve-rejects/
# Copyright (c) 2026, runZero, Inc.

set -euo pipefail

### Defaults
YEAR=2025
FORCE=0
REPO=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --repo)
            REPO="$2"
            shift 2
            ;;
        --year)
            YEAR="$2"
            shift 2
            ;;
        --force)
            FORCE=1
            shift
            ;;
        --help|-h)
            tail -n +2 "$0" | sed -n '/^#/p; /^#/!q' | cut -c3-
            exit 0
            ;;
        *)
            echo "Error: Unknown option: $1" >&2
            exit 1
            ;;
    esac
done

if [[ -z "$REPO" ]]; then
    echo "Error: --repo is required." >&2
    exit 1
fi

if [[ ! -d "$REPO" ]]; then
    echo "Error: Directory '$REPO' does not exist." >&2
    exit 1
fi

cd "$REPO"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Writing outputs in $(pwd)"

OUT_REJECTED="cveaudit-rejected.txt"
OUT_DISPUTED_TODAY="cveaudit-disputed-today.txt"
OUT_REJECTED_AFTER_PUBLISHED="cveaudit-rejected-after-published.txt"
OUT_REJECTED_AFTER_DISPUTED="cveaudit-rejected-after-disputed.txt"
OUT_REJECTED_UNPUBLISHED="cveaudit-rejected-unpublished.txt"

OUTFILES=(
    "$OUT_REJECTED"
    "$OUT_DISPUTED_TODAY"
    "$OUT_REJECTED_AFTER_PUBLISHED"
    "$OUT_REJECTED_AFTER_DISPUTED"
    "$OUT_REJECTED_UNPUBLISHED"
)

if [[ $FORCE -ne 1 ]]; then
    for f in "${OUTFILES[@]}"; do
        if [[ -e "$f" ]]; then
            echo "Error: $f already exists. Use --force to overwrite." >&2
            exit 1
        fi
    done
fi

# Temp staging directory because just YOLO writing is bad for you.
TMPDIR="$(mktemp -d -t cveaudit.XXXXXX)"
trap 'rm -rf "$TMPDIR"' EXIT

TMP_REJECTED="$TMPDIR/$OUT_REJECTED"
TMP_DISPUTED_TODAY="$TMPDIR/$OUT_DISPUTED_TODAY"
TMP_REJECTED_AFTER_PUBLISHED="$TMPDIR/$OUT_REJECTED_AFTER_PUBLISHED"
TMP_REJECTED_AFTER_DISPUTED="$TMPDIR/$OUT_REJECTED_AFTER_DISPUTED"
TMP_REJECTED_UNPUBLISHED="$TMPDIR/$OUT_REJECTED_UNPUBLISHED"

: > "$TMP_REJECTED"
: > "$TMP_DISPUTED_TODAY"
: > "$TMP_REJECTED_AFTER_PUBLISHED"
: > "$TMP_REJECTED_AFTER_DISPUTED"
: > "$TMP_REJECTED_UNPUBLISHED"

total_cves=$(find "cves/$YEAR" -name '*.json' | wc -l | tr -d ' ')

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Found $total_cves total CVE records for year $YEAR"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Gathering currently disputed CVEs (latest commit)"

disputed_files=($(find "cves/$YEAR" -name '*.json' \
    -exec jq -r 'select(.containers.cna.tags and (.containers.cna.tags[] == "disputed")) | input_filename' {} +))

printf "%s\n" "${disputed_files[@]}" > "$TMP_DISPUTED_TODAY"

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Gathering rejected CVE files..."

rejected_files=($(find "cves/$YEAR" -name '*.json' \
    -exec jq -r 'select(.cveMetadata.state == "REJECTED") | input_filename' {} +))

rejected_total=${#rejected_files}

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting audit of $rejected_total rejected CVE records"

count=0
for file in "${rejected_files[@]}"; do
    count=$((count+1))
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$count/$rejected_total] scanning $file"

    had_disputed=0
    had_published=0

    for commit in $(git rev-list HEAD -- "$file"); do
        content=$(git show "${commit}:${file}" 2>/dev/null || true)
        [[ -z "$content" ]] && continue

        if echo "$content" | jq -e '.containers.cna.tags? | index("disputed")' >/dev/null 2>&1; then
            had_disputed=1
        fi

        if echo "$content" | jq -e '.cveMetadata.state == "PUBLISHED"' >/dev/null 2>&1; then
            had_published=1
        fi

        [[ $had_disputed -eq 1 && $had_published -eq 1 ]] && break
    done

    echo "$file" >> "$TMP_REJECTED"

    if [[ $had_disputed -eq 1 ]]; then
        echo "$file" >> "$TMP_REJECTED_AFTER_DISPUTED"
    elif [[ $had_published -eq 1 ]]; then
        echo "$file" >> "$TMP_REJECTED_AFTER_PUBLISHED"
    else
        echo "$file" >> "$TMP_REJECTED_UNPUBLISHED"
    fi
done

for f in "${OUTFILES[@]}"; do
    [[ $FORCE -eq 1 && -e "$f" ]] && rm -f "$f"
    mv "$TMPDIR/$f" "$f"
done

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Completed audit:"
echo "  [*] Total CVE records:    $total_cves"
echo "  [*] Rejected CVE records: $rejected_total"
echo "  [*] Year:                 $YEAR"

wc -l "${OUTFILES[@]}"
